
-- إنشاء جدول العيادات
CREATE TABLE public.clinics (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  clinic_name TEXT NOT NULL,
  license_number TEXT NOT NULL UNIQUE,
  doctor_name TEXT,
  specialization TEXT NOT NULL,
  license_status TEXT NOT NULL DEFAULT 'active' CHECK (license_status IN ('active', 'expired', 'suspended', 'pending')),
  issue_date DATE,
  expiry_date DATE,
  phone TEXT,
  contact_info JSONB,
  address TEXT,
  coordinates POINT,
  verification_count INTEGER DEFAULT 0,
  qr_code TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- إنشاء جدول تتبع التحقق
CREATE TABLE public.verifications (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  clinic_id UUID REFERENCES public.clinics(id) ON DELETE CASCADE,
  license_number TEXT NOT NULL,
  verification_method TEXT NOT NULL CHECK (verification_method IN ('qr_scan', 'manual_entry', 'image_upload')),
  verification_status TEXT NOT NULL CHECK (verification_status IN ('success', 'failed', 'not_found')),
  ip_address INET,
  user_agent TEXT,
  location_data JSONB,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- إنشاء فهارس لتحسين الأداء
CREATE INDEX idx_clinics_license_number ON public.clinics(license_number);
CREATE INDEX idx_clinics_status ON public.clinics(license_status);
CREATE INDEX idx_clinics_expiry_date ON public.clinics(expiry_date);
CREATE INDEX idx_verifications_clinic_id ON public.verifications(clinic_id);
CREATE INDEX idx_verifications_created_at ON public.verifications(created_at);

-- تفعيل Row Level Security
ALTER TABLE public.clinics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.verifications ENABLE ROW LEVEL SECURITY;

-- سياسات الأمان للعيادات (قراءة عامة)
CREATE POLICY "Anyone can view clinics" 
  ON public.clinics 
  FOR SELECT 
  USING (true);

-- سياسات الأمان للتحقق (قراءة عامة، إدراج عام)
CREATE POLICY "Anyone can view verifications" 
  ON public.verifications 
  FOR SELECT 
  USING (true);

CREATE POLICY "Anyone can create verifications" 
  ON public.verifications 
  FOR INSERT 
  WITH CHECK (true);

-- إنشاء دالة لتحديث عدد التحقق تلقائياً
CREATE OR REPLACE FUNCTION update_verification_count()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.verification_status = 'success' THEN
    UPDATE public.clinics 
    SET verification_count = verification_count + 1,
        updated_at = now()
    WHERE license_number = NEW.license_number;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- إنشاء trigger لتحديث عدد التحقق
CREATE TRIGGER trigger_update_verification_count
  AFTER INSERT ON public.verifications
  FOR EACH ROW
  EXECUTE FUNCTION update_verification_count();

-- دالة لتوليد QR code
CREATE OR REPLACE FUNCTION generate_qr_code_data(license_num TEXT)
RETURNS TEXT AS $$
BEGIN
  RETURN license_num;
END;
$$ LANGUAGE plpgsql;

-- إدراج بيانات تجريبية للعيادات الأردنية (65 عيادة)
INSERT INTO public.clinics (clinic_name, license_number, doctor_name, specialization, license_status, issue_date, expiry_date, phone, address, qr_code) VALUES
('عيادة النور لطب الأسنان', 'JOR-DEN-001', 'د. أحمد محمد الخطيب', 'طب الأسنان العام', 'active', '2023-01-15', '2025-01-15', '+962 6 461 2345', 'شارع الملك فيصل، عمان', 'JOR-DEN-001'),
('مركز الأردن لتقويم الأسنان', 'JOR-DEN-002', 'د. فاطمة علي النجار', 'تقويم الأسنان', 'active', '2023-02-10', '2025-02-10', '+962 6 593 7821', 'دوار الداخلية، عمان', 'JOR-DEN-002'),
('عيادة الشفاء للأسنان', 'JOR-DEN-003', 'د. محمود سليم الزعبي', 'جراحة الفم والأسنان', 'active', '2023-03-05', '2025-03-05', '+962 6 534 9876', 'جبل عمان، عمان', 'JOR-DEN-003'),
('مجمع الصحة الطبي', 'JOR-DEN-004', 'د. سارة حسام التل', 'طب أسنان الأطفال', 'expired', '2022-04-20', '2024-04-20', '+962 6 478 2134', 'شارع الجاردنز، عمان', 'JOR-DEN-004'),
('عيادة الرحمة لطب الأسنان', 'JOR-DEN-005', 'د. خالد أمين الحموري', 'علاج الجذور', 'active', '2023-05-12', '2025-05-12', '+962 6 515 6789', 'عبدون، عمان', 'JOR-DEN-005'),
('مركز الأسنان المتخصص', 'JOR-DEN-006', 'د. نور الدين العموش', 'أمراض اللثة', 'active', '2023-06-08', '2025-06-08', '+962 6 592 3456', 'شارع مكة، عمان', 'JOR-DEN-006'),
('عيادة الأردن للأسنان', 'JOR-DEN-007', 'د. ليلى محمد الكيلاني', 'طب الأسنان التجميلي', 'active', '2023-07-15', '2025-07-15', '+962 6 543 7890', 'تلاع العلي، عمان', 'JOR-DEN-007'),
('مركز الابتسامة الطبي', 'JOR-DEN-008', 'د. عمر فؤاد البطاينة', 'زراعة الأسنان', 'active', '2023-08-20', '2025-08-20', '+962 6 476 5432', 'الصويفية، عمان', 'JOR-DEN-008'),
('عيادة السلام لطب الأسنان', 'JOR-DEN-009', 'د. رانيا سمير العجلوني', 'طب الأسنان العام', 'suspended', '2023-09-10', '2025-09-10', '+962 6 528 9012', 'خلدا، عمان', 'JOR-DEN-009'),
('مجمع الحياة الطبي', 'JOR-DEN-010', 'د. طارق جمال الشريف', 'تقويم الأسنان', 'active', '2023-10-05', '2025-10-05', '+962 6 487 3456', 'دير غبار، عمان', 'JOR-DEN-010'),

-- عيادات إربد
('عيادة إربد لطب الأسنان', 'JOR-DEN-011', 'د. حسام محمد العمري', 'طب الأسنان العام', 'active', '2023-01-25', '2025-01-25', '+962 2 724 5678', 'شارع الجامعة، إربد', 'JOR-DEN-011'),
('مركز الشمال للأسنان', 'JOR-DEN-012', 'د. منى أحمد الخرابشة', 'جراحة الفم والأسنان', 'active', '2023-02-18', '2025-02-18', '+962 2 735 9012', 'حي الحصن، إربد', 'JOR-DEN-012'),
('عيادة الأردن الحديثة', 'JOR-DEN-013', 'د. يوسف سليم الزغول', 'تقويم الأسنان', 'active', '2023-03-22', '2025-03-22', '+962 2 746 7834', 'شارع فلسطين، إربد', 'JOR-DEN-013'),
('مجمع العافية الطبي', 'JOR-DEN-014', 'د. هالة خليل البشير', 'طب أسنان الأطفال', 'active', '2023-04-14', '2025-04-14', '+962 2 728 4567', 'حي الأشرفية، إربد', 'JOR-DEN-014'),
('عيادة التقدم للأسنان', 'JOR-DEN-015', 'د. وليد محمود الطراونة', 'علاج الجذور', 'expired', '2022-05-08', '2024-05-08', '+962 2 751 2345', 'الحي الشرقي، إربد', 'JOR-DEN-015'),

-- عيادات الزرقاء
('مركز الزرقاء للأسنان', 'JOR-DEN-016', 'د. سلمى عبدالله الدعجة', 'طب الأسنان العام', 'active', '2023-06-12', '2025-06-12', '+962 5 395 6789', 'الزرقاء الجديدة', 'JOR-DEN-016'),
('عيادة الأمل لطب الأسنان', 'JOR-DEN-017', 'د. محمد علي الشواهين', 'أمراض اللثة', 'active', '2023-07-20', '2025-07-20', '+962 5 382 4567', 'حي الأزهار، الزرقاء', 'JOR-DEN-017'),
('مجمع الشرق الطبي', 'JOR-DEN-018', 'د. نادية حسن العواد', 'زراعة الأسنان', 'active', '2023-08-15', '2025-08-15', '+962 5 374 8901', 'شارع الملك طلال، الزرقاء', 'JOR-DEN-018'),
('عيادة النهضة للأسنان', 'JOR-DEN-019', 'د. عبدالرحمن فايز القضاة', 'طب الأسنان التجميلي', 'active', '2023-09-08', '2025-09-08', '+962 5 368 2345', 'الزرقاء القديمة', 'JOR-DEN-019'),
('مركز الإشراق الطبي', 'JOR-DEN-020', 'د. آمال أحمد الزواهرة', 'تقويم الأسنان', 'active', '2023-10-12', '2025-10-12', '+962 5 391 5678', 'حي النزهة، الزرقاء', 'JOR-DEN-020'),

-- عيادات السلط
('عيادة السلط للأسنان', 'JOR-DEN-021', 'د. جمال محمد الكفاوين', 'طب الأسنان العام', 'active', '2023-01-30', '2025-01-30', '+962 5 355 7890', 'وسط البلد، السلط', 'JOR-DEN-021'),
('مركز البلقاء للأسنان', 'JOR-DEN-022', 'د. إيمان سامي المعايطة', 'جراحة الفم والأسنان', 'active', '2023-02-25', '2025-02-25', '+962 5 341 2345', 'حي الجدعة، السلط', 'JOR-DEN-022'),
('عيادة الوادي للأسنان', 'JOR-DEN-023', 'د. مأمون عيسى الحياري', 'علاج الجذور', 'active', '2023-03-18', '2025-03-18', '+962 5 367 8901', 'عين الباشا، السلط', 'JOR-DEN-023'),
('مجمع الأردن الطبي', 'JOR-DEN-024', 'د. فداء خالد العدوان', 'طب أسنان الأطفال', 'active', '2023-04-22', '2025-04-22', '+962 5 348 5678', 'الرمة، السلط', 'JOR-DEN-024'),
('عيادة التطوير للأسنان', 'JOR-DEN-025', 'د. زياد محمود النعيمات', 'أمراض اللثة', 'expired', '2022-05-15', '2024-05-15', '+962 5 352 3456', 'الصبيحي، السلط', 'JOR-DEN-025'),

-- عيادات الكرك
('مركز الكرك للأسنان', 'JOR-DEN-026', 'د. لؤي أحمد المجالي', 'طب الأسنان العام', 'active', '2023-06-18', '2025-06-18', '+962 3 235 6789', 'وسط الكرك', 'JOR-DEN-026'),
('عيادة الجنوب للأسنان', 'JOR-DEN-027', 'د. سهير محمد الطراونة', 'تقويم الأسنان', 'active', '2023-07-25', '2025-07-25', '+962 3 241 7890', 'حي الثقافة، الكرك', 'JOR-DEN-027'),
('مجمع الكرك الطبي', 'JOR-DEN-028', 'د. بسام سليم العموش', 'زراعة الأسنان', 'active', '2023-08-20', '2025-08-20', '+962 3 258 4567', 'المزار الجنوبي، الكرك', 'JOR-DEN-028'),
('عيادة الأصالة للأسنان', 'JOR-DEN-029', 'د. رولا عبدالله الدلابيح', 'طب الأسنان التجميلي', 'active', '2023-09-12', '2025-09-12', '+962 3 267 8901', 'قطرانة، الكرك', 'JOR-DEN-029'),
('مركز الشفاء الطبي', 'JOR-DEN-030', 'د. عماد فؤاد الزبون', 'جراحة الفم والأسنان', 'active', '2023-10-08', '2025-10-08', '+962 3 274 2345', 'الثنية، الكرك', 'JOR-DEN-030'),

-- عيادات إضافية في عمان
('عيادة الخليج للأسنان', 'JOR-DEN-031', 'د. نبيل حسام الرفاعي', 'طب الأسنان العام', 'active', '2023-11-05', '2025-11-05', '+962 6 551 2345', 'شارع الملكة رانيا، عمان', 'JOR-DEN-031'),
('مركز القدس للأسنان', 'JOR-DEN-032', 'د. ديانا محمد السعود', 'علاج الجذور', 'active', '2023-11-15', '2025-11-15', '+962 6 563 6789', 'شميساني، عمان', 'JOR-DEN-032'),
('عيادة الحداثة للأسنان', 'JOR-DEN-033', 'د. فراس علي الحنيطي', 'أمراض اللثة', 'active', '2023-11-25', '2025-11-25', '+962 6 575 9012', 'مرج الحمام، عمان', 'JOR-DEN-033'),
('مجمع العاصمة الطبي', 'JOR-DEN-034', 'د. رنا سمير البطوش', 'طب أسنان الأطفال', 'active', '2023-12-02', '2025-12-02', '+962 6 587 3456', 'أبو علندا، عمان', 'JOR-DEN-034'),
('عيادة الفردوس للأسنان', 'JOR-DEN-035', 'د. حازم محمود الصمادي', 'تقويم الأسنان', 'suspended', '2023-12-10', '2025-12-10', '+962 6 598 7890', 'سحاب، عمان', 'JOR-DEN-035'),

-- عيادات أخرى متفرقة
('مركز عجلون للأسنان', 'JOR-DEN-036', 'د. أحمد يوسف الفريحات', 'طب الأسنان العام', 'active', '2023-01-12', '2025-01-12', '+962 2 642 1234', 'عجلون', 'JOR-DEN-036'),
('عيادة جرش للأسنان', 'JOR-DEN-037', 'د. سلوى محمد الخطيب', 'جراحة الفم والأسنان', 'active', '2023-02-08', '2025-02-08', '+962 2 635 5678', 'جرش', 'JOR-DEN-037'),
('مجمع مأدبا الطبي', 'JOR-DEN-038', 'د. كمال أحمد النوايسة', 'زراعة الأسنان', 'active', '2023-03-15', '2025-03-15', '+962 5 324 9012', 'مأدبا', 'JOR-DEN-038'),
('عيادة معان للأسنان', 'JOR-DEN-039', 'د. هيفاء سليم الحويطات', 'طب الأسنان التجميلي', 'active', '2023-04-20', '2025-04-20', '+962 3 213 3456', 'معان', 'JOR-DEN-039'),
('مركز الطفيلة للأسنان', 'JOR-DEN-040', 'د. محمد خالد الحجايا', 'تقويم الأسنان', 'active', '2023-05-25', '2025-05-25', '+962 3 224 7890', 'الطفيلة', 'JOR-DEN-040'),

-- المزيد من العيادات في المحافظات
('عيادة العقبة للأسنان', 'JOR-DEN-041', 'د. نائل محمود المومني', 'طب الأسنان العام', 'active', '2023-06-30', '2025-06-30', '+962 3 201 2345', 'العقبة', 'JOR-DEN-041'),
('مجمع البحر الأحمر الطبي', 'JOR-DEN-042', 'د. آية عبدالله العوران', 'أمراض اللثة', 'active', '2023-07-12', '2025-07-12', '+962 3 209 6789', 'العقبة', 'JOR-DEN-042'),
('عيادة الرصيفة للأسنان', 'JOR-DEN-043', 'د. باسم أحمد الربيحات', 'علاج الجذور', 'active', '2023-08-08', '2025-08-08', '+962 6 474 5678', 'الرصيفة', 'JOR-DEN-043'),
('مركز الموقر للأسنان', 'JOR-DEN-044', 'د. رنا سامي العجارمة', 'طب أسنان الأطفال', 'expired', '2022-09-15', '2024-09-15', '+962 6 483 9012', 'الموقر', 'JOR-DEN-044'),
('عيادة القويسمة للأسنان', 'JOR-DEN-045', 'د. عمار محمد الشديفات', 'جراحة الفم والأسنان', 'active', '2023-10-20', '2025-10-20', '+962 6 492 3456', 'القويسمة', 'JOR-DEN-045'),

-- عيادات متخصصة إضافية
('مركز الأسنان المتقدم', 'JOR-DEN-046', 'د. سارة فايز الزعبي', 'زراعة الأسنان', 'active', '2023-11-12', '2025-11-12', '+962 6 512 7890', 'وادي صقرة، عمان', 'JOR-DEN-046'),
('عيادة التميز للأسنان', 'JOR-DEN-047', 'د. وائل حسن الخوالدة', 'طب الأسنان التجميلي', 'active', '2023-11-28', '2025-11-28', '+962 6 524 1234', 'الجويدة، عمان', 'JOR-DEN-047'),
('مجمع الإبداع الطبي', 'JOR-DEN-048', 'د. لينا محمود البلبيسي', 'تقويم الأسنان', 'active', '2023-12-15', '2025-12-15', '+962 6 536 5678', 'ناعور، عمان', 'JOR-DEN-048'),
('عيادة الرائدة للأسنان', 'JOR-DEN-049', 'د. طلال أحمد الغرايبة', 'طب الأسنان العام', 'active', '2023-12-22', '2025-12-22', '+962 6 548 9012', 'البيادر، عمان', 'JOR-DEN-049'),
('مركز الصحة الشاملة', 'JOR-DEN-050', 'د. ميسون سليم العبادي', 'أمراض اللثة', 'active', '2024-01-05', '2026-01-05', '+962 6 559 3456', 'طبربور، عمان', 'JOR-DEN-050'),

-- العيادات الـ 15 الأخيرة
('عيادة المستقبل للأسنان', 'JOR-DEN-051', 'د. راكان محمد الزيود', 'علاج الجذور', 'active', '2024-01-15', '2026-01-15', '+962 6 571 7890', 'الهاشمي الشمالي، عمان', 'JOR-DEN-051'),
('مجمع الرعاية الطبي', 'JOR-DEN-052', 'د. حنين خالد الشوابكة', 'طب أسنان الأطفال', 'active', '2024-01-25', '2026-01-25', '+962 6 583 2345', 'ماركا، عمان', 'JOR-DEN-052'),
('عيادة الإنجاز للأسنان', 'JOR-DEN-053', 'د. علاء الدين فؤاد المعشر', 'جراحة الفم والأسنان', 'pending', '2024-02-02', '2026-02-02', '+962 6 594 6789', 'أم أذينة، عمان', 'JOR-DEN-053'),
('مركز الأمانة للأسنان', 'JOR-DEN-054', 'د. شذى حسام البكار', 'زراعة الأسنان', 'active', '2024-02-12', '2026-02-12', '+962 6 505 9012', 'المقابلين، عمان', 'JOR-DEN-054'),
('عيادة الحكمة للأسنان', 'JOR-DEN-055', 'د. غسان محمود الطويل', 'طب الأسنان التجميلي', 'active', '2024-02-20', '2026-02-20', '+962 6 517 3456', 'الجبيهة، عمان', 'JOR-DEN-055'),
('مجمع النور الطبي', 'JOR-DEN-056', 'د. ريم أحمد الدقامسة', 'تقويم الأسنان', 'active', '2024-02-28', '2026-02-28', '+962 6 529 7890', 'اليادودة، عمان', 'JOR-DEN-056'),
('عيادة الازدهار للأسنان', 'JOR-DEN-057', 'د. معاذ سليم الحديدي', 'طب الأسنان العام', 'active', '2024-03-08', '2026-03-08', '+962 6 541 1234', 'ضاحية الأمير راشد، عمان', 'JOR-DEN-057'),
('مركز التطوير للأسنان', 'JOR-DEN-058', 'د. دانا محمد الشرعة', 'أمراض اللثة', 'active', '2024-03-18', '2026-03-18', '+962 6 553 5678', 'الضليل، عمان', 'JOR-DEN-058'),
('عيادة الرقي للأسنان', 'JOR-DEN-059', 'د. سامر خليل العساف', 'علاج الجذور', 'active', '2024-03-25', '2026-03-25', '+962 6 565 9012', 'بيرين، عمان', 'JOR-DEN-059'),
('مجمع الأردن المتقدم', 'JOR-DEN-060', 'د. نغم فايز الحباشنة', 'طب أسنان الأطفال', 'active', '2024-04-02', '2026-04-02', '+962 6 577 3456', 'الجاردنز، عمان', 'JOR-DEN-060'),
('عيادة الفخامة للأسنان', 'JOR-DEN-061', 'د. عبدالكريم محمود السعودي', 'جراحة الفم والأسنان', 'active', '2024-04-12', '2026-04-12', '+962 6 589 7890', 'دابوق، عمان', 'JOR-DEN-061'),
('مركز النجاح للأسنان', 'JOR-DEN-062', 'د. ربى حسان الرواشدة', 'زراعة الأسنان', 'active', '2024-04-20', '2026-04-20', '+962 6 501 2345', 'أم السماق، عمان', 'JOR-DEN-062'),
('عيادة البيان للأسنان', 'JOR-DEN-063', 'د. ماهر أحمد الطراونة', 'طب الأسنان التجميلي', 'active', '2024-04-28', '2026-04-28', '+962 6 513 6789', 'ضاحية الحاج حسن، عمان', 'JOR-DEN-063'),
('مجمع الريادة الطبي', 'JOR-DEN-064', 'د. سندس سليم العلاونة', 'تقويم الأسنان', 'active', '2024-05-05', '2026-05-05', '+962 6 525 9012', 'حي نزال، عمان', 'JOR-DEN-064'),
('عيادة الأولى للأسنان', 'JOR-DEN-065', 'د. بلال محمد القرالة', 'طب الأسنان العام', 'active', '2024-05-15', '2026-05-15', '+962 6 537 3456', 'ضاحية الياسمين، عمان', 'JOR-DEN-065');
